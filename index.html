<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Prayer Times ‚Äî Pro UI</title>
  <meta name="description" content="Accurate prayer times with polished UI, location, calendar export, and notification controls." />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>
    /* ---------------- Design system ---------------- */
    :root{
      --bg1: #f7fdf8;
      --bg2: #ffffff;
      --green-600:#15a56b;
      --green-700:#0e8b56;
      --muted:#9aa3a0;
      --card:#ffffff;
      --glass: rgba(255,255,255,0.85);
      --shadow-lg: 0 12px 30px rgba(15,40,35,0.12);
      --radius:18px;
      --accent:#f59e0b;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color-scheme: light;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: linear-gradient(180deg,var(--bg1) 0%, var(--bg2) 60%);
      padding:22px;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      min-height:100vh;
    }
    .container{
      width:100%;
      max-width:420px;
    }

    /* ---------- Header ---------- */
    .header{
      background: linear-gradient(90deg,var(--green-700),var(--green-600));
      color:white;
      padding:18px;
      border-radius:14px;
      box-shadow:var(--shadow-lg);
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
    }
    .header-left{flex:1}
    .date-main{font-weight:700;font-size:16px;letter-spacing:0.2px}
    .date-sub{opacity:0.95;font-size:13px;margin-top:6px}
    .quran{
      width:64px;height:64px;border-radius:12px;background:rgba(255,255,255,0.06);display:flex;align-items:center;justify-content:center;
      flex-shrink:0;
    }

    /* location bar */
    .location-bar{
      margin-top:12px;
      background: linear-gradient(90deg,#fff8f8,#fff);
      border-radius:12px;
      padding:10px 12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      box-shadow: 0 6px 16px rgba(15,40,35,0.04);
    }
    .loc-left{display:flex;gap:8px;align-items:center}
    .btn{
      appearance:none;border:0;padding:9px 12px;border-radius:10px;font-weight:700;cursor:pointer;
      display:inline-flex;gap:8px;align-items:center;justify-content:center;
    }
    .btn.primary{background:var(--green-600);color:white}
    .btn.ghost{background:transparent;color:var(--green-600);border:1px solid rgba(255,255,255,0.06)}

    /* ---------- Card ---------- */
    .card{
      margin-top:18px;
      background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.98));
      border-radius:var(--radius);
      padding:12px;
      box-shadow:var(--shadow-lg);
      position:relative;
      overflow:visible;
    }
    .card-head{
      display:flex;justify-content:space-between;align-items:center;padding:10px 6px;border-radius:10px;
      background: linear-gradient(90deg,var(--green-700),var(--green-600));
      color:white;margin-bottom:14px;
    }
    .card-head .title{font-weight:800;font-size:16px}
    .card-head small{opacity:0.95;font-weight:600}

    /* timeline + list */
    .prayer-area{display:flex;gap:12px;padding:6px}
    .timeline{
      width:56px;display:flex;flex-direction:column;align-items:center;padding-top:6px;position:relative;
    }
    .timeline::before{
      content:"";position:absolute;left:26px;top:22px;bottom:22px;width:6px;border-radius:6px;background:linear-gradient(#e9f6ee,#fff);
    }
    .timeline .dot{width:14px;height:14px;border-radius:50%;background:var(--green-600);margin:10px 0;box-shadow:0 6px 18px rgba(14,139,86,0.14)}

    .list{flex:1;display:flex;flex-direction:column;gap:6px}
    .row{
      display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;min-height:58px;
      transition:transform .18s ease, box-shadow .18s ease, background .18s ease;
      background: linear-gradient(180deg, rgba(255,255,255,0.8), rgba(255,255,255,0.92));
    }
    .row:hover{transform:translateY(-4px);box-shadow:0 10px 30px rgba(15,40,35,.06)}
    .row .left{display:flex;flex-direction:column}
    .pray-name{font-weight:700;font-size:18px}
    .pray-time{font-weight:600;color:var(--muted);margin-top:6px}
    .actions{display:flex;gap:10px;align-items:center}
    .bell{width:40px;height:40px;border-radius:10px;border:0;background:transparent;cursor:pointer;color:var(--muted)}
    .bell.active{color:var(--green-700);transform:scale(1.03)}
    .small-note{font-size:12px;color:#9aa3a0;margin-top:8px}

    /* watermark */
    .watermark{
      position:absolute;left:0;right:0;top:120px;bottom:0;opacity:0.06;pointer-events:none;background-image:
      url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 480"><g fill="%23000"><rect x="0" y="0" width="640" height="480" fill="none"/><path d="M320 40c-48 0-84 36-84 84v108H84v132h472V232H404V124c0-48-36-84-84-84z"/></g></svg>');
      background-position:center;background-repeat:no-repeat;background-size:contain;border-radius:12px;
    }

    /* footer + controls */
    .controls{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:10px}
    .fab{
      position:fixed;right:28px;bottom:28px;background:var(--green-700);color:white;width:56px;height:56px;border-radius:16px;
      display:flex;align-items:center;justify-content:center;box-shadow: 0 16px 40px rgba(14,139,86,0.16);border:0;font-size:20px;cursor:pointer;
    }

    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(6,12,8,0.36);display:none;align-items:center;justify-content:center;padding:18px}
    .modal{width:100%;max-width:520px;border-radius:12px;background:var(--card);padding:18px;box-shadow:var(--shadow-lg)}
    .modal .row{background:transparent;box-shadow:none;padding:6px 0}
    .field{display:flex;flex-direction:column;gap:6px;margin-top:8px}
    .input{padding:10px 12px;border-radius:10px;border:1px solid #e7e7e7;font-weight:600}

    /* small screens */
    @media (max-width:420px){
      .header{padding:14px}
      .date-main{font-size:15px}
      .card{padding:10px}
      .timeline{width:44px}
    }

    /* accessibility */
    button:focus,.btn:focus{outline:3px solid rgba(14,139,86,0.14);outline-offset:3px}
  </style>
</head>
<body>
  <div class="container" id="app" aria-live="polite">
    <!-- Header -->
    <div class="header" role="banner">
      <div class="header-left">
        <div class="date-main" id="displayDate">Fri 21 November 2025</div>
        <div class="date-sub" id="displayHijri">30 JumƒÅdƒÅ al-.. ‚Äî Fri 21 Nov 2025</div>
      </div>
      <div class="quran" aria-hidden="true">
        <svg width="46" height="46" viewBox="0 0 24 24" fill="none"><path d="M3 5c0-1 1-2 2-2h6l3 2 3-2h1c1 0 2 .9 2 2v14c0 1-1 2-2 2h-1l-3-2-3 2H5c-1 0-2-.9-2-2V5z" fill="white"/></svg>
      </div>
    </div>

    <div class="location-bar" role="region" aria-label="Location controls">
      <div class="loc-left">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="flex-shrink:0;margin-right:6px"><path d="M12 2C8 2 5 5 5 9c0 5 7 13 7 13s7-8 7-13c0-4-3-7-7-7z" fill="#c44747"/></svg>
        <div>
          <div style="font-weight:700">Accurate prayer times</div>
          <div style="font-size:13px;color:#6b6b6b" id="locLabel">Location: unknown ‚Ä¢ Using approximate times</div>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn primary" id="btnLocate">Enable location</button>
        <button class="btn" id="btnSearch">Search</button>
        <button class="btn" id="btnSettings" title="Settings">‚öôÔ∏è</button>
      </div>
    </div>

    <!-- Main card -->
    <section class="card" role="main" aria-labelledby="prayerTitle">
      <div class="card-head">
        <div>
          <div class="title" id="monthTitle">30 JumƒÅdƒÅ al-..</div>
          <small id="subDate">Fri 21 November 2025</small>
        </div>
        <div style="display:flex;gap:10px">
          <button class="btn" id="prevDay" aria-label="Previous day">‚Äπ</button>
          <button class="btn" id="nextDay" aria-label="Next day">‚Ä∫</button>
          <button class="btn" id="fetchAlAdhan" title="Fetch high accuracy (AlAdhan)">AlAdhan</button>
        </div>
      </div>

      <div class="prayer-area" role="list" aria-label="Prayer times">
        <div class="timeline" aria-hidden="true">
          <div style="height:6px"></div>
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
          <div style="flex:1"></div>
        </div>

        <div class="list" id="prayersContainer">
          <!-- rows inserted by JS -->
        </div>
      </div>

      <div class="small-note" style="margin-top:10px" id="infoNote">Times are calculated client-side. Use AlAdhan for higher accuracy or change method in Settings.</div>

      <div class="controls">
        <button class="btn" id="btnExport">Export ICS</button>
      </div>

      <div class="watermark" aria-hidden="true"></div>
    </section>

    <footer style="text-align:center;color:#6b6b6b;margin-top:14px;font-size:13px">
      Built with care ‚Ä¢ Save as <code>index.html</code> and deploy
    </footer>
  </div>

  <!-- Floating settings button -->
  <button class="fab" id="openSettings" aria-label="Open settings">‚öôÔ∏è</button>

  <!-- Modal (hidden) -->
  <div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document" aria-labelledby="modalTitle">
      <h3 id="modalTitle" style="margin:0">Settings & Location</h3>

      <div class="field">
        <label style="font-weight:700">Calculation source</label>
        <select id="calcSource" class="input" aria-label="Calculation source">
          <option value="calc">Local calculation (fast)</option>
          <option value="aladhan">AlAdhan API (recommended)</option>
        </select>
      </div>

      <div class="field">
        <label style="font-weight:700">Asr method</label>
        <select id="asrMethod" class="input">
          <option value="1">Standard (Shafi'i) ‚Äî factor 1</option>
          <option value="2">Hanafi ‚Äî factor 2</option>
        </select>
      </div>

      <div class="field">
        <label style="font-weight:700">Manual timezone offset (hours)</label>
        <input id="tzInput" class="input" placeholder="leave empty for device timezone" />
      </div>

      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:14px">
        <button class="btn" id="closeModal">Close</button>
        <button class="btn primary" id="saveSettings">Save</button>
      </div>
    </div>
  </div>

  <script>
  /*************************************************************************
   * Utilities & small prayer calculator (improved readability & features)
   * - Includes optional AlAdhan fetch
   * - ICS export generation
   * - Local notification scheduling while the page is open
   *************************************************************************/

  (function(){
    /* ---------- Helpers ---------- */
    const $ = (selector, el=document) => el.querySelector(selector);
    const $$ = (selector, el=document) => Array.from(el.querySelectorAll(selector));

    function dtr(d){ return d * Math.PI / 180; }
    function rtd(r){ return r * 180 / Math.PI; }
    function pad2(n){ return String(n).padStart(2,'0'); }

    function isoDateLocal(d){
      // return YYYY-MM-DD
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    }

    function formatTimeFromDecimal(h){
      if(isNaN(h)) return '--:--';
      h = (h + 24) % 24;
      const H = Math.floor(h);
      const M = Math.floor((h - H) * 60 + 0.5);
      return `${pad2(H)}:${pad2(M)}`;
    }

    // Simple client-side Hijri (arithmetical) + small formatter
    function gregToHijri(gDate){
      const day = gDate.getDate(), month = gDate.getMonth()+1, year = gDate.getFullYear();
      const jd = Math.floor((1461*(year+4800 + Math.floor((month-14)/12)))/4)
               + Math.floor((367*(month-2-12*(Math.floor((month-14)/12))))/12)
               - Math.floor((3*(Math.floor((year+4900 + Math.floor((month-14)/12))/100)))/4)
               + day - 32075;
      let l = jd - 1948440 + 10632;
      const n = Math.floor((l - 1) / 10631);
      l = l - 10631 * n + 354;
      const j = (Math.floor((10985 - l) / 5316)) * (Math.floor((50 * l) / 17719)) + (Math.floor(l / 5670)) * (Math.floor((43 * l) / 15238));
      l = l - (Math.floor((30 - j) / 15)) * (Math.floor((17719 * j) / 50)) - (Math.floor(j / 16)) * (Math.floor((15238 * j) / 43)) + 29;
      const m = Math.floor((24 * l) / 709);
      const d = l - Math.floor((709 * m) / 24);
      const y = 30 * n + j - 30;
      return {y, m, d};
    }

    /* ---------- Solar math (compact, approximate) ---------- */
    function julianDate(y,m,d){
      if(m<=2){ y--; m+=12; }
      const A = Math.floor(y/100);
      const B = 2 - A + Math.floor(A/4);
      return Math.floor(365.25*(y+4716)) + Math.floor(30.6001*(m+1)) + d + B - 1524.5;
    }
    function sunPos(jd){
      const D = jd - 2451545.0;
      const g = 357.529 + 0.98560028 * D;
      const q = 280.459 + 0.98564736 * D;
      const L = q + 1.915 * Math.sin(dtr(g)) + 0.020 * Math.sin(dtr(2*g));
      const e = 23.439 - 0.00000036 * D;
      const RA = rtd(Math.atan2(Math.cos(dtr(e)) * Math.sin(dtr(L)), Math.cos(dtr(L)))) / 15;
      const decl = rtd(Math.asin(Math.sin(dtr(e)) * Math.sin(dtr(L))));
      const eqt = q/15 - RA;
      return {decl, eqt};
    }
    function solarNoon(jd, lon){
      const eqt = sunPos(jd).eqt;
      return 12 - eqt - lon/15;
    }
    function computeHourAngle(angle, decl, lat){
      const cosH = (Math.cos(dtr(angle)) - Math.sin(dtr(lat)) * Math.sin(dtr(decl))) / (Math.cos(dtr(lat)) * Math.cos(dtr(decl)));
      if(cosH < -1 || cosH > 1) return NaN;
      return rtd(Math.acos(cosH));
    }

    /* ---------- Prayer calculation wrapper ---------- */
    const PrayerCalc = {
      getTimesLocal: function(date, coords, opts){
        // coords: {lat, lon, timezone}
        // opts: {fajrAngle, ishaAngle, asrMethod}
        opts = Object.assign({fajrAngle:18, ishaAngle:18, asrMethod:1}, opts || {});
        const lat = coords.lat, lon = coords.lon, tz = coords.timezone;
        const parts = { y: date.getFullYear(), m: date.getMonth()+1, d: date.getDate() };
        const jd = julianDate(parts.y, parts.m, parts.d);
        const noon = solarNoon(jd, lon);
        const sun = sunPos(jd);
        const times = {};
        // Dhuhr
        times.Dhuhr = formatTimeFromDecimal(noon + tz);
        // Sunrise / Maghrib (sun altitude ~ -0.833)
        const haSunrise = computeHourAngle(90.833, sun.decl, lat);
        times.Sunrise = formatTimeFromDecimal((noon - haSunrise/15) + tz);
        times.Maghrib = formatTimeFromDecimal((noon + haSunrise/15) + tz);
        // Fajr / Isha using twilight angles
        const haFajr = computeHourAngle(180 - opts.fajrAngle, sun.decl, lat);
        const haIsha = computeHourAngle(180 - opts.ishaAngle, sun.decl, lat);
        times.Fajr = formatTimeFromDecimal((noon - haFajr/15) + tz);
        times.Isha = formatTimeFromDecimal((noon + haIsha/15) + tz);
        // Asr (approx): angle: atan(1 + factor)
        const factor = opts.asrMethod === 2 ? 2 : 1;
        const angleAsr = rtd(Math.atan(1 + factor));
        const haAsr = computeHourAngle(90 + angleAsr, sun.decl, lat);
        times.Asr = formatTimeFromDecimal((noon + haAsr/15) + tz);
        return times;
      },
      getTimesAlAdhan: async function(date, coords, opts){
        // Calls AlAdhan API for full-featured times. No API key needed for public endpoints.
        // Returns times or throws error.
        try{
          const method = opts.method || 2; // default method param
          const timestamp = Math.floor(date.getTime()/1000);
          // Using 'timings' endpoint by timestamp
          const url = `https://api.aladhan.com/v1/timings/${timestamp}?latitude=${coords.lat}&longitude=${coords.lon}&method=${method}&school=${opts.asrMethod==2?1:0}`;
          const resp = await fetch(url);
          if(!resp.ok) throw new Error('AlAdhan fetch failed: ' + resp.status);
          const data = await resp.json();
          if(data.code !== 200) throw new Error('AlAdhan error: ' + (data.status || 'unknown'));
          // Map fields to our set: Fajr, Sunrise, Dhuhr, Asr, Maghrib, Isha
          const t = data.data.timings;
          return {
            Fajr: t.Fajr.slice(0,5),
            Sunrise: t.Sunrise.slice(0,5),
            Dhuhr: t.Dhuhr.slice(0,5),
            Asr: t.Asr.slice(0,5),
            Maghrib: t.Maghrib.slice(0,5),
            Isha: t.Isha.slice(0,5)
          };
        }catch(e){ throw e; }
      }
    };

    /* ---------- ICS Export ---------- */
    function makeICS(date, coords, times){
      // date: Date; times: {Fajr:"05:12",...}
      const lines = [];
      function dtToICS(date, timeStr){
        // date local + timeStr "HH:MM" -> UTC basic format YYYYMMDDTHHMM00Z
        const [hh, mm] = timeStr.split(':').map(Number);
        const d = new Date(date.getFullYear(), date.getMonth(), date.getDate(), hh, mm, 0);
        return d.toISOString().replace(/[-:]/g,'').split('.')[0] + 'Z';
      }
      const uid = 'prayer-' + Date.now() + '@pro-pray.local';
      lines.push('BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//ProPrayer//EN','CALSCALE:GREGORIAN');
      for(const p of ['Fajr','Dhuhr','Asr','Maghrib','Isha']){
        if(!times[p]) continue;
        lines.push('BEGIN:VEVENT');
        lines.push('UID:' + uid + '-' + p);
        lines.push('SUMMARY:' + p + ' prayer');
        lines.push('DTSTAMP:' + new Date().toISOString().replace(/[-:]/g,'').split('.')[0] + 'Z');
        lines.push('DTSTART:' + dtToICS(date, times[p]));
        // default event 15 minutes
        const [hh, mm] = times[p].split(':').map(Number);
        const end = new Date(date.getFullYear(), date.getMonth(), date.getDate(), hh, mm + 15);
        lines.push('DTEND:' + end.toISOString().replace(/[-:]/g,'').split('.')[0] + 'Z');
        lines.push('END:VEVENT');
      }
      lines.push('END:VCALENDAR');
      return lines.join('\r\n');
    }

    /* ---------- App state & UI ---------- */
    const state = {
      coords: null, // {lat, lon, timezone, name}
      date: new Date(),
      prefs: {
        calcSource: localStorage.getItem('calcSource') || 'calc',
        asrMethod: parseInt(localStorage.getItem('asrMethod') || '1', 10),
        tzManual: localStorage.getItem('tzManual') || '', // optional manual timezone offset
        useAlAdhan: localStorage.getItem('useAlAdhan') === 'true'
      },
      times: null,
      alarms: JSON.parse(localStorage.getItem('prayerPrefs') || '{}'),
      nextTimers: [] // references to setTimeout for scheduled notifications
    };

    // UI elements
    const displayDate = $('#displayDate');
    const displayHijri = $('#displayHijri');
    const monthTitle = $('#monthTitle');
    const subDate = $('#subDate');
    const locLabel = $('#locLabel');
    const prayersContainer = $('#prayersContainer');
    const infoNote = $('#infoNote');

    // update header dates
    function updateDates(){
      const d = state.date;
      const opts = {weekday:'short', day:'2-digit', month:'long', year:'numeric'};
      displayDate.textContent = d.toLocaleDateString(undefined, opts);
      subDate.textContent = d.toLocaleDateString(undefined, opts);
      const hij = gregToHijri(d);
      displayHijri.textContent = `${hij.d} JumƒÅdƒÅ al-.. ‚Ä¢ ${displayDate.textContent}`;
      monthTitle.textContent = `${hij.d} JumƒÅdƒÅ al-..`;
    }

    // render prayer list
    function renderList(){
      prayersContainer.innerHTML = '';
      const order = ['Fajr','Sunrise','Dhuhr','Asr','Maghrib','Isha'];
      for(const p of order){
        const row = document.createElement('div');
        row.className = 'row';
        row.setAttribute('data-prayer', p);
        row.innerHTML = `
          <div class="left">
            <div class="pray-name">${p}</div>
            <div class="pray-time" id="time-${p}">--:--</div>
          </div>
          <div class="actions">
            <button class="bell" data-prayer="${p}" aria-pressed="false" title="Toggle ${p} reminder">üîî</button>
          </div>
        `;
        prayersContainer.appendChild(row);
      }
      // attach bell handlers, restore states
      $$('.bell').forEach(b=>{
        const pr = b.dataset.prayer;
        if(state.alarms[pr]){ b.classList.add('active'); b.setAttribute('aria-pressed','true'); }
        b.addEventListener('click', ()=>{
          const active = b.classList.toggle('active');
          b.setAttribute('aria-pressed', active ? 'true' : 'false');
          state.alarms[pr] = active;
          localStorage.setItem('prayerPrefs', JSON.stringify(state.alarms));
          if(active) scheduleNotificationForPrayer(pr);
          else cancelNotificationForPrayer(pr);
        });
      });
    }

    // write times into UI
    function displayTimes(times){
      state.times = times;
      for(const k in times){
        const el = $(`#time-${k}`);
        if(el) el.textContent = times[k];
      }
    }

    // compute timezone offset to use
    function getTimezoneOffsetHours(){
      if(state.prefs.tzManual && state.prefs.tzManual.trim()!=='') {
        const val = parseFloat(state.prefs.tzManual);
        if(!isNaN(val)) return val;
      }
      return -(new Date()).getTimezoneOffset() / 60;
    }

    // compute times using either local calc or AlAdhan
    async function computeTimesAndRender(){
      updateDates();
      // show placeholder
      displayTimes({Fajr:'--:--', Sunrise:'--:--', Dhuhr:'--:--', Asr:'--:--', Maghrib:'--:--', Isha:'--:--'});
      if(!state.coords){
        locLabel.textContent = 'Location: unknown ‚Ä¢ Using approximate times (default city)';
        // default to Dhaka if none (user from Bangladesh is likely)
        state.coords = {lat:23.7, lon:90.4, timezone:getTimezoneOffsetHours(), name:'Dhaka (approx)'};
      }
      const coords = {lat: state.coords.lat, lon: state.coords.lon, timezone: getTimezoneOffsetHours()};
      try {
        let times;
        if(state.prefs.calcSource === 'aladhan' || state.prefs.useAlAdhan){
          infoNote.textContent = 'Fetching times from AlAdhan‚Ä¶';
          times = await PrayerCalc.getTimesAlAdhan(state.date, coords, {asrMethod: state.prefs.asrMethod});
          infoNote.textContent = 'Using AlAdhan API results.';
        } else {
          infoNote.textContent = 'Calculating times locally‚Ä¶';
          times = PrayerCalc.getTimesLocal(state.date, coords, {fajrAngle:18, ishaAngle:18, asrMethod: state.prefs.asrMethod});
          infoNote.textContent = 'Local calculation used. Switch to AlAdhan for higher fidelity.';
        }
        displayTimes(times);
        locLabel.textContent = `Location: ${state.coords.name || `${coords.lat.toFixed(3)}, ${coords.lon.toFixed(3)}`}`;
        // schedule notifications for toggled alarms (clear old timers)
        clearAllScheduled();
        for(const p of Object.keys(state.alarms)){
          if(state.alarms[p]) scheduleNotificationForPrayer(p);
        }
      } catch(err){
        console.error(err);
        infoNote.textContent = 'Error calculating times: ' + (err.message || String(err));
      }
    }

    /* ---------- Geolocation & search ---------- */
    async function enableGeolocation(){
      if(!navigator.geolocation) { alert('Geolocation not supported'); return; }
      $('#btnLocate').disabled = true; $('#btnLocate').textContent = 'Locating‚Ä¶';
      navigator.geolocation.getCurrentPosition(async (pos)=>{
        const lat = pos.coords.latitude, lon = pos.coords.longitude;
        // best-effort reverse geocode
        const name = await reverseGeocodeName(lat, lon);
        state.coords = {lat, lon, name, timezone: getTimezoneOffsetHours()};
        $('#btnLocate').textContent = 'Location enabled';
        computeTimesAndRender();
      }, (err)=>{
        console.warn(err);
        alert('Location denied or unavailable.');
        $('#btnLocate').disabled = false; $('#btnLocate').textContent = 'Enable location';
      }, {enableHighAccuracy:true, timeout:10000});
    }

    async function reverseGeocodeName(lat, lon){
      try{
        const resp = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`);
        if(!resp.ok) return null;
        const data = await resp.json();
        return data.address && (data.address.city || data.address.town || data.address.village || data.address.state) || data.display_name;
      }catch(e){ return null; }
    }

    // manual search prompt using Nominatim
    async function promptSearch(){
      const q = prompt('Search for city or place (e.g., "Dhaka, Bangladesh")');
      if(!q) return;
      try{
        const resp = await fetch(`https://nominatim.openstreetmap.org/search?format=jsonv2&q=${encodeURIComponent(q)}&limit=1`);
        if(!resp.ok) throw new Error('Search failed');
        const data = await resp.json();
        if(!data || data.length===0) { alert('No results'); return; }
        const first = data[0];
        state.coords = {lat: parseFloat(first.lat), lon: parseFloat(first.lon), name: first.display_name, timezone: getTimezoneOffsetHours()};
        computeTimesAndRender();
      }catch(e){ alert('Search error: ' + e.message); }
    }

    /* ---------- Notifications scheduling (in-page) ---------- */
    function scheduleNotificationForPrayer(prayerName){
      // if no times yet, do nothing
      if(!state.times || !state.times[prayerName]) return;
      // Cancel existing for this prayer
      cancelNotificationForPrayer(prayerName);
      // compute ms until that time (local)
      const timeStr = state.times[prayerName]; // "HH:MM"
      const [hh, mm] = timeStr.split(':').map(Number);
      const target = new Date(state.date.getFullYear(), state.date.getMonth(), state.date.getDate(), hh, mm, 0);
      const now = new Date();
      let diff = target - now;
      if(diff < 0) {
        // schedule for next day
        diff += 24 * 3600 * 1000;
      }
      // schedule a gentle notification while tab open
      const id = setTimeout(async ()=>{
        // show a friendly in-page notification (and system notification if permitted)
        showInPageNotification(`${prayerName} ‚Ä¢ ${timeStr}`, `It's time for ${prayerName} prayer.`);
        if(Notification && Notification.permission === 'granted'){
          new Notification(`${prayerName} ‚Äî Prayer time`, {body: `It's ${timeStr} ‚Ä¢ ${prayerName}`, tag: 'prayer-'+prayerName});
        }
      }, diff);
      state.nextTimers.push({prayer:prayerName, id});
    }

    function cancelNotificationForPrayer(prayerName){
      const toRemove = state.nextTimers.filter(t => t.prayer === prayerName);
      for(const t of toRemove) clearTimeout(t.id);
      state.nextTimers = state.nextTimers.filter(t => t.prayer !== prayerName);
    }
    function clearAllScheduled(){ state.nextTimers.forEach(t=>clearTimeout(t.id)); state.nextTimers = []; }

    function showInPageNotification(title, message){
      // small top floating alert
      const el = document.createElement('div');
      el.style.position='fixed'; el.style.left='50%'; el.style.top='22px'; el.style.transform='translateX(-50%)';
      el.style.background='linear-gradient(90deg, rgba(255,255,255,0.95), rgba(255,255,255,0.98))';
      el.style.padding='12px 18px'; el.style.borderRadius='12px'; el.style.boxShadow='0 8px 30px rgba(8,20,12,0.12)';
      el.style.zIndex=9999; el.style.fontWeight=700;
      el.textContent = `${title} ‚Äî ${message}`;
      document.body.appendChild(el);
      setTimeout(()=>el.style.transition='opacity .5s', 20);
      setTimeout(()=>el.style.opacity='0', 4600);
      setTimeout(()=>el.remove(), 5200);
    }

    /* ---------- ICS export handler ---------- */
    function exportICS(){
      if(!state.times) { alert('No times available'); return; }
      const ics = makeICS(state.date, state.coords || {}, state.times);
      const blob = new Blob([ics], {type:'text/calendar;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `prayer-times-${isoDateLocal(state.date)}.ics`;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    /* ---------- Navigation handlers ---------- */
    function prevDay(){
      state.date.setDate(state.date.getDate() - 1);
      computeTimesAndRender();
    }
    function nextDay(){
      state.date.setDate(state.date.getDate() + 1);
      computeTimesAndRender();
    }

    /* ---------- Modal (settings) ---------- */
    const modalBackdrop = $('#modalBackdrop');
    function openModal(){
      $('#calcSource').value = state.prefs.calcSource;
      $('#asrMethod').value = String(state.prefs.asrMethod);
      $('#tzInput').value = state.prefs.tzManual || '';
      modalBackdrop.style.display = 'flex';
      modalBackdrop.setAttribute('aria-hidden','false');
    }
    function closeModal(){
      modalBackdrop.style.display = 'none';
      modalBackdrop.setAttribute('aria-hidden','true');
    }
    function saveSettings(){
      state.prefs.calcSource = $('#calcSource').value;
      state.prefs.asrMethod = parseInt($('#asrMethod').value,10);
      state.prefs.tzManual = $('#tzInput').value.trim();
      localStorage.setItem('calcSource', state.prefs.calcSource);
      localStorage.setItem('asrMethod', String(state.prefs.asrMethod));
      localStorage.setItem('tzManual', state.prefs.tzManual || '');
      // if calcSource is aladhan, set useAlAdhan toggle for UI convenience
      state.prefs.useAlAdhan = state.prefs.calcSource === 'aladhan';
      localStorage.setItem('useAlAdhan', state.prefs.useAlAdhan ? 'true' : 'false');
      closeModal();
      computeTimesAndRender();
    }

    /* ---------- Quick AlAdhan fetch button ---------- */
    $('#fetchAlAdhan').addEventListener('click', async ()=>{
      state.prefs.calcSource = 'aladhan';
      state.prefs.useAlAdhan = true;
      localStorage.setItem('calcSource','aladhan');
      localStorage.setItem('useAlAdhan','true');
      computeTimesAndRender();
    });

    /* ---------- Bind UI controls ---------- */
    $('#btnLocate').addEventListener('click', enableGeolocation);
    $('#btnSearch').addEventListener('click', promptSearch);
    $('#btnExport').addEventListener('click', exportICS);
    $('#prevDay').addEventListener('click', prevDay);
    $('#nextDay').addEventListener('click', nextDay);

    $('#btnSettings').addEventListener('click', openModal);
    $('#openSettings').addEventListener('click', openModal);
    $('#closeModal').addEventListener('click', closeModal);
    $('#saveSettings').addEventListener('click', saveSettings);

    // close modal on backdrop click
    modalBackdrop.addEventListener('click', (e)=>{ if(e.target === modalBackdrop) closeModal(); });

    // Allow notification permission request
    function ensureNotificationPermission(){
      if(!('Notification' in window)) return;
      if(Notification.permission === 'default'){
        // we ask permission only when user toggles an alarm ‚Äî here we do a gentle prompt
        // But to make demo convenient, ask once when they open settings
        Notification.requestPermission().then(permission => {
          console.log('Notification permission:', permission);
        });
      }
    }
    $('#openSettings').addEventListener('click', ensureNotificationPermission);

    /* ---------- init ---------- */
    (function init(){
      // Render empty list & load saved alarm toggles
      renderList();
      updateDates();
      // Load saved prefs already in state
      // Initial compute
      computeTimesAndRender();
      // Refresh at midnight
      (function scheduleMidnightRefresh(){
        const now = new Date();
        const midnight = new Date(now.getFullYear(), now.getMonth(), now.getDate()+1, 0, 0, 5);
        const ms = midnight - now;
        setTimeout(()=>{
          state.date = new Date();
          computeTimesAndRender();
          scheduleMidnightRefresh();
        }, ms);
      })();
      // small accessibility: keyboard shortcut "s" opens settings
      window.addEventListener('keydown', (e)=>{ if(e.key === 's' || e.key === 'S') openModal(); });
    })();

  })();
  </script>
</body>
</html>